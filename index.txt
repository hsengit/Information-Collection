<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hsençš„è³‡è¨Šæ•´ç†ç«™ (Firebase SPA)</title>
    
    <!-- 1. å¼•å…¥ Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. è¨­å®š Tailwind ä¸»é¡Œèˆ‡è®Šæ•¸ -->
    <script>
        tailwind.config = {
            darkMode: 'class', // å•Ÿç”¨ class æ¨¡å¼çš„æ·±è‰²æ”¯æ´
            theme: {
                extend: {
                    colors: {
                        skin: {
                            fill: 'var(--color-fill)',
                            card: 'var(--color-card)',
                            border: 'var(--color-border)',
                            text: 'var(--color-text)',
                            muted: 'var(--color-muted)',
                            primary: 'var(--color-primary)',
                            'primary-hover': 'var(--color-primary-hover)',
                        }
                    }
                }
            }
        }
    </script>

    <!-- å¼•å…¥ Google Fonts: Noto Sans TC -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- å¼•å…¥ Font Awesome Icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- å¼•å…¥ QR Code ç”Ÿæˆåº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <!-- Firebase SDK (Compat version) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        
        /* éš±è—æ²è»¸ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* æ–‡å­—æˆªæ–· */
        .line-clamp-1 { display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .line-clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        .line-clamp-4 { display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden; }

        /* å‹•ç•« */
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .loader { border: 4px solid var(--color-border); border-top: 4px solid var(--color-primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- ä¸»é¡Œè®Šæ•¸å®šç¾© --- */
        :root {
            /* é è¨­: ç¾ä»£ç™½ (Modern) */
            --color-fill: #f3f4f6;       /* bg-gray-100 */
            --color-card: #ffffff;       /* bg-white */
            --color-border: #e5e7eb;     /* border-gray-200 */
            --color-text: #1f2937;       /* text-gray-800 */
            --color-muted: #6b7280;      /* text-gray-500 */
            --color-primary: #2563eb;    /* blue-600 */
            --color-primary-hover: #1d4ed8; /* blue-700 */
        }

        /* æ¥µç°¡é»‘ (Dark) */
        [data-theme="dark"] {
            --color-fill: #111827;       /* gray-900 */
            --color-card: #1f2937;       /* gray-800 */
            --color-border: #374151;     /* gray-700 */
            --color-text: #f3f4f6;       /* gray-100 */
            --color-muted: #9ca3af;      /* gray-400 */
            --color-primary: #3b82f6;    /* blue-500 */
            --color-primary-hover: #60a5fa; /* blue-400 */
        }

        /* è­·çœ¼æš– (Warm) */
        [data-theme="warm"] {
            --color-fill: #f5f5dc;       /* beige */
            --color-card: #fdf6e3;       /* solarized light base */
            --color-border: #d6d3c0;
            --color-text: #5c4b37;       /* brownish */
            --color-muted: #8b7e6a;
            --color-primary: #d97706;    /* amber-600 */
            --color-primary-hover: #b45309;
        }

        /* æ£®æ—ç¶  (Forest) */
        [data-theme="forest"] {
            --color-fill: #ecfdf5;       /* green-50 */
            --color-card: #ffffff;
            --color-border: #a7f3d0;     /* green-200 */
            --color-text: #064e3b;       /* green-900 */
            --color-muted: #047857;      /* green-700 */
            --color-primary: #059669;    /* emerald-600 */
            --color-primary-hover: #047857;
        }

        /* IMAC æœå‡é¢¨æ ¼ (Jelly) - Bondi Blue */
        [data-theme="jelly"] {
            --color-fill: #e0f7fa;       /* Cyan 50 - Fallback */
            --color-card: rgba(255, 255, 255, 0.85); /* åŠé€æ˜ç™½ */
            --color-border: #4dd0e1;     /* Cyan 300 */
            --color-text: #006064;       /* Cyan 900 */
            --color-muted: #00838f;      /* Cyan 800 */
            --color-primary: #00bcd4;    /* Cyan 500 */
            --color-primary-hover: #0097a7;
        }
        /* æœå‡é¢¨æ ¼èƒŒæ™¯ç‰¹æ•ˆ */
        [data-theme="jelly"] body {
            background-image: radial-gradient(circle at 50% 50%, #e0f7fa 0%, #4dd0e1 100%);
            background-attachment: fixed;
        }

        /* æ¼¸å±¤ç²‰å½©é¢¨æ ¼ (Pastel Gradient) */
        [data-theme="pastel"] {
            --color-fill: #fff0f5;       /* LavenderBlush - Fallback */
            --color-card: rgba(255, 255, 255, 0.7); /* é«˜é€æ˜åº¦æ¯›ç»ç’ƒ */
            --color-border: #fbcfe8;     /* Pink 200 */
            --color-text: #831843;       /* Pink 900 */
            --color-muted: #be185d;      /* Pink 700 */
            --color-primary: #f472b6;    /* Pink 400 */
            --color-primary-hover: #db2777;
        }
        /* ç²‰å½©é¢¨æ ¼èƒŒæ™¯ç‰¹æ•ˆ */
        [data-theme="pastel"] body {
            background-image: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%); /* éŠ€ç™½æ¼¸å±¤åº• */
            background-image: linear-gradient(120deg, #a1c4fd 0%, #c2e9fb 100%); /* é è¨­æ¸…çˆ½è— */
            background-image: linear-gradient(to top, #fbc2eb 0%, #a6c1ee 100%); /* å¤¢å¹»ç²‰ç´«æ¼¸å±¤ */
            background-attachment: fixed;
        }
    </style>

    <script>
        // ==========================================
        //  è¨­å®šå€åŸŸ (Configuration Zone)
        // ==========================================

        const hardcodedConfig = {
            apiKey: "AIzaSyArz3JJKNyidUYsIs0uRP5ODsrAWDX2Bes",
            authDomain: "information-collection-9f366.firebaseapp.com",
            projectId: "information-collection-9f366",
            storageBucket: "information-collection-9f366.firebasestorage.app",
            messagingSenderId: "499059728632",
            appId: "1:499059728632:web:105374f7b4658923c59b0d"
        };

        // å…¨åŸŸè®Šæ•¸
        let db = null;
        let auth = null;
        let currentUser = null;
        let isAdmin = false;
        
        let categoryStructure = {}; 
        let allTags = new Set();
        let allData = [];
        let filteredData = [];
        let isEditing = false;
        let editingId = null;
        
        // ç‹€æ…‹è®Šæ•¸
        let currentCategory = 'å…¨éƒ¨';
        let currentSubCategory = 'å…¨éƒ¨';
        let currentViewMode = 'medium'; // small, medium, large, list
        let currentTheme = 'modern';    // modern, dark, warm, forest, jelly, pastel
        
        // åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', async () => {
            loadTheme(); // è¼‰å…¥ä¸»é¡Œ
            await initApp();
        });

        async function initApp() {
            const config = await determineConfig();
            
            if (config) {
                try {
                    firebase.initializeApp(config);
                    auth = firebase.auth();
                    db = firebase.firestore();
                    
                    await auth.signInAnonymously();
                    
                    auth.onAuthStateChanged((user) => {
                        if (user) {
                            currentUser = user;
                            console.log("Firebase é€£ç·šæˆåŠŸï¼Œä½¿ç”¨è€… ID:", user.uid);
                            loadData();
                            loadCategories();
                            updateUIState(true);
                        }
                    });
                } catch (e) {
                    console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", e);
                    alert("Firebase è¨­å®šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ Console æˆ–é‡æ–°è¨­å®šã€‚");
                    updateUIState(false);
                }
            } else {
                updateUIState(false);
            }
        }

        async function determineConfig() {
            const urlParams = new URLSearchParams(window.location.search);
            const configParam = urlParams.get('config');
            if (configParam) {
                try {
                    const configObj = JSON.parse(atob(configParam));
                    localStorage.setItem('firebase_config', JSON.stringify(configObj));
                    window.history.replaceState({}, document.title, window.location.pathname);
                    return configObj;
                } catch (e) { console.error("Config è§£æå¤±æ•—", e); }
            }
            if (hardcodedConfig.apiKey !== "demo" && hardcodedConfig.apiKey !== "") return hardcodedConfig;
            const localConfig = localStorage.getItem('firebase_config');
            return localConfig ? JSON.parse(localConfig) : null;
        }

        function updateUIState(isConnected) {
            const connectedUI = document.getElementById('connected-ui');
            const setupWarning = document.getElementById('setup-warning');
            if (isConnected) {
                setupWarning.classList.add('hidden');
                connectedUI.classList.remove('opacity-50', 'pointer-events-none');
            } else {
                setupWarning.classList.remove('hidden');
            }
        }

        // æ¨™ç±¤é¡è‰² (æ”¯æ´æ·±è‰²æ¨¡å¼é©é…)
        function getTagClass(tag) {
            // ä½¿ç”¨ Tailwind çš„ opacity åŠŸèƒ½ä¾†é©é…ä¸åŒèƒŒæ™¯
            const colors = [
                'bg-red-100 text-red-800 dark:bg-red-900/40 dark:text-red-200',
                'bg-orange-100 text-orange-800 dark:bg-orange-900/40 dark:text-orange-200',
                'bg-amber-100 text-amber-800 dark:bg-amber-900/40 dark:text-amber-200',
                'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/40 dark:text-yellow-200',
                'bg-lime-100 text-lime-800 dark:bg-lime-900/40 dark:text-lime-200',
                'bg-green-100 text-green-800 dark:bg-green-900/40 dark:text-green-200',
                'bg-emerald-100 text-emerald-800 dark:bg-emerald-900/40 dark:text-emerald-200',
                'bg-teal-100 text-teal-800 dark:bg-teal-900/40 dark:text-teal-200',
                'bg-cyan-100 text-cyan-800 dark:bg-cyan-900/40 dark:text-cyan-200',
                'bg-sky-100 text-sky-800 dark:bg-sky-900/40 dark:text-sky-200',
                'bg-blue-100 text-blue-800 dark:bg-blue-900/40 dark:text-blue-200',
                'bg-indigo-100 text-indigo-800 dark:bg-indigo-900/40 dark:text-indigo-200',
                'bg-violet-100 text-violet-800 dark:bg-violet-900/40 dark:text-violet-200',
                'bg-purple-100 text-purple-800 dark:bg-purple-900/40 dark:text-purple-200',
                'bg-fuchsia-100 text-fuchsia-800 dark:bg-fuchsia-900/40 dark:text-fuchsia-200',
                'bg-pink-100 text-pink-800 dark:bg-pink-900/40 dark:text-pink-200',
                'bg-rose-100 text-rose-800 dark:bg-rose-900/40 dark:text-rose-200'
            ];
            let hash = 0;
            for (let i = 0; i < tag.length; i++) hash = tag.charCodeAt(i) + ((hash << 5) - hash);
            return colors[Math.abs(hash) % colors.length];
        }
    </script>
</head>
<body class="bg-skin-fill text-skin-text min-h-screen flex flex-col transition-colors duration-300 bg-cover">

    <!-- å°è¦½åˆ— -->
    <nav class="bg-skin-card shadow-md sticky top-0 z-40 border-b border-skin-border transition-colors duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <i class="fa-solid fa-layer-group text-skin-primary text-2xl mr-2"></i>
                    <h1 class="text-xl font-bold hidden sm:block">Hsençš„è³‡è¨Šæ•´ç†ç«™</h1>
                    
                    <button onclick="toggleAdminPanel()" id="admin-btn" class="ml-4 bg-skin-fill hover:brightness-95 text-skin-text px-3 py-1.5 rounded-md text-xs sm:text-sm font-medium transition">
                        <i class="fa-solid fa-lock mr-1"></i> ç®¡ç†è€…ç™»å…¥
                    </button>

                    <button onclick="openAddModal()" id="add-data-btn" class="hidden ml-2 bg-skin-primary hover:bg-skin-primary-hover text-white px-3 py-1.5 rounded-md text-xs sm:text-sm font-medium transition shadow-sm">
                        <i class="fa-solid fa-plus mr-1"></i> æ–°å¢è³‡æ–™
                    </button>
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="openModal('help-modal')" class="text-skin-muted hover:text-skin-primary px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fa-regular fa-circle-question mr-1"></i> èªªæ˜
                    </button>
                    <button onclick="openModal('settings-modal')" class="text-skin-muted hover:text-skin-primary px-3 py-2 rounded-md text-sm font-medium">
                        <i class="fa-solid fa-gear mr-1"></i> è¨­å®š
                    </button>
                </div>
            </div>
        </div>
        
        <!-- æ¬¡ç´šå°è¦½ï¼šæœå°‹èˆ‡ç¯©é¸ -->
        <div class="bg-skin-fill/50 border-t border-skin-border py-3 transition-colors duration-300 backdrop-blur-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-col gap-3">
                
                <!-- ç¬¬ä¸€åˆ— -->
                <div class="flex flex-col sm:flex-row gap-3 items-center justify-between">
                    <!-- ä¸»é¡åˆ¥ç¯©é¸ -->
                    <div class="flex overflow-x-auto no-scrollbar space-x-2 w-full sm:w-auto pb-1 sm:pb-0" id="category-filter-container">
                        <button class="bg-skin-primary text-white px-3 py-1 rounded-full text-sm whitespace-nowrap active-cat" onclick="filterByCategory('å…¨éƒ¨', this)">å…¨éƒ¨</button>
                    </div>
                    
                    <!-- å·¥å…·åˆ—: æœå°‹ / ä¸»é¡Œ / ç‰ˆé¢ / æ’åº -->
                    <div class="flex flex-wrap w-full sm:w-auto space-x-2 shrink-0 items-center justify-end">
                        <div class="relative w-full sm:w-40 md:w-48 mb-2 sm:mb-0">
                            <input type="text" id="search-input" oninput="handleSearch()" placeholder="æœå°‹..." class="w-full pl-8 pr-2 py-1.5 border border-skin-border bg-skin-card text-skin-text rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-skin-primary placeholder-skin-muted">
                            <i class="fa-solid fa-magnifying-glass absolute left-2.5 top-2.5 text-skin-muted text-xs"></i>
                        </div>
                        
                        <!-- ä¸»é¡Œé¸æ“‡ -->
                        <select id="theme-select" onchange="handleThemeChange()" class="border border-skin-border bg-skin-card text-skin-text rounded-md text-sm px-2 py-1.5 focus:outline-none cursor-pointer" title="åˆ‡æ›ä¸»é¡Œ">
                            <option value="modern">âšª ç¾ä»£ç™½</option>
                            <option value="dark">âš« æ¥µç°¡é»‘</option>
                            <option value="warm">ğŸŸ¤ è­·çœ¼æš–</option>
                            <option value="forest">ğŸŸ¢ æ£®æ—ç¶ </option>
                            <option value="jelly">ğŸ¬ æœå‡é¢¨</option>
                            <option value="pastel">ğŸ¨ æ¼¸å±¤ç²‰</option>
                        </select>

                        <!-- ç‰ˆé¢é¸æ“‡ -->
                        <select id="view-select" onchange="handleViewChange()" class="border border-skin-border bg-skin-card text-skin-text rounded-md text-sm px-2 py-1.5 focus:outline-none cursor-pointer" title="åˆ‡æ›ç‰ˆé¢">
                            <option value="medium" selected>ğŸ”² å¡ç‰‡(ä¸­)</option>
                            <option value="small">â¬› å¡ç‰‡(å°)</option>
                            <option value="large">â¬œ å¡ç‰‡(å¤§)</option>
                            <option value="list">â˜° åˆ—è¡¨æ¨¡å¼</option>
                        </select>

                        <select id="sort-select" onchange="handleSort()" class="border border-skin-border bg-skin-card text-skin-text rounded-md text-sm px-2 py-1.5 focus:outline-none cursor-pointer">
                            <option value="newest">æœ€æ–°</option>
                            <option value="oldest">æœ€æ—©</option>
                        </select>
                    </div>
                </div>

                <!-- ç¬¬äºŒåˆ—: å­é¡åˆ¥ç¯©é¸ (å‹•æ…‹é¡¯ç¤º) -->
                <div id="subcategory-wrapper" class="hidden border-t border-skin-border pt-2 animate-fade-in">
                    <div class="flex items-center text-xs text-skin-muted mb-1">
                        <i class="fa-solid fa-turn-up rotate-90 mr-2 ml-1"></i> å­é¡åˆ¥ç¯©é¸ï¼š
                    </div>
                    <div class="flex overflow-x-auto no-scrollbar space-x-2 pb-1" id="subcategory-filter-container"></div>
                </div>

            </div>
        </div>
    </nav>

    <!-- å°šæœªè¨­å®šæç¤º -->
    <div id="setup-warning" class="hidden bg-yellow-50 border-l-4 border-yellow-400 p-4 m-4 max-w-7xl mx-auto rounded shadow-sm text-gray-800">
        <div class="flex">
            <div class="flex-shrink-0"><i class="fa-solid fa-triangle-exclamation text-yellow-400"></i></div>
            <div class="ml-3">
                <p class="text-sm">å°šæœªè¨­å®š Firebase é€£ç·šã€‚ç›®å‰ç‚ºå±•ç¤ºæ¨¡å¼ã€‚è«‹é»æ“Šå³ä¸Šè§’ <strong>[è¨­å®š]</strong>ã€‚</p>
            </div>
        </div>
    </div>

    <!-- ä¸»å…§å®¹å€ -->
    <main class="flex-grow p-4 sm:p-6 lg:p-8 transition-colors duration-300" id="connected-ui">
        <!-- Grid å®¹å™¨ -->
        <div id="data-grid" class="max-w-7xl mx-auto grid gap-6">
            <div class="col-span-full text-center py-20 text-skin-muted">
                <div class="inline-block loader mb-2"></div><p>è³‡æ–™è¼‰å…¥ä¸­...</p>
            </div>
        </div>
    </main>

    <!-- é å°¾ -->
    <footer class="bg-skin-card border-t border-skin-border mt-auto py-4 transition-colors duration-300 backdrop-blur-sm">
        <div class="max-w-7xl mx-auto px-4 text-center text-skin-muted text-xs">
            &copy; 2024 Info Collector. Powered by Firebase Firestore.
        </div>
    </footer>

    <!-- ================= æ¨¡æ…‹è¦–çª—å€ ================= -->

    <!-- 1. è³‡æ–™è©³æƒ…è¦–çª— -->
    <div id="detail-modal" class="fixed inset-0 z-50 hidden bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-skin-card rounded-lg shadow-xl w-full max-w-5xl max-h-[90vh] overflow-hidden flex flex-col md:flex-row relative animate-fade-in border border-skin-border">
            <button onclick="closeModal('detail-modal')" class="absolute top-2 right-2 md:top-4 md:right-4 bg-skin-fill hover:brightness-95 rounded-full w-8 h-8 flex items-center justify-center text-skin-muted z-10"><i class="fa-solid fa-times"></i></button>
            
            <div class="w-full md:w-1/2 bg-skin-fill/50 flex flex-col items-center justify-center p-6 border-r border-skin-border relative">
                <div class="flex-grow w-full flex items-center justify-center overflow-hidden mb-4 relative" style="min-height: 200px;">
                    <img id="detail-img" src="" class="max-w-full max-h-[40vh] md:max-h-[65vh] object-contain shadow-sm rounded bg-skin-card">
                </div>
                <div class="flex justify-center space-x-3 w-full shrink-0">
                    <a id="detail-download-btn" href="#" download="image.jpg" class="flex items-center bg-skin-card hover:bg-skin-fill text-skin-text border border-skin-border px-5 py-2 rounded-full text-sm font-medium shadow-sm transition">
                        <i class="fa-solid fa-download mr-2 text-skin-primary"></i> ä¸‹è¼‰
                    </a>
                    <button onclick="viewFullImage()" class="flex items-center bg-skin-card hover:bg-skin-fill text-skin-text border border-skin-border px-5 py-2 rounded-full text-sm font-medium shadow-sm transition">
                        <i class="fa-solid fa-expand mr-2 text-skin-primary"></i> çœ‹å…¨åœ–
                    </button>
                </div>
            </div>

            <div class="w-full md:w-1/2 p-6 overflow-y-auto bg-skin-card flex flex-col text-skin-text">
                <div class="mb-4">
                    <span id="detail-category" class="text-xs font-semibold text-skin-primary bg-skin-fill px-2 py-1 rounded">é¡åˆ¥ > å­é¡åˆ¥</span>
                    <h2 id="detail-title" class="text-2xl font-bold mt-2 mb-2">æ¨™é¡Œ</h2>
                    <div id="detail-tags" class="flex flex-wrap gap-1 mb-4 text-xs text-skin-muted"></div>
                </div>
                <div class="bg-skin-fill p-4 rounded-lg border border-skin-border flex-grow">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-sm font-bold">èªªæ˜å…§å®¹</h3>
                        <button onclick="copyToClipboard('detail-desc')" class="text-skin-muted hover:text-skin-primary text-xs"><i class="fa-regular fa-copy"></i> è¤‡è£½</button>
                    </div>
                    <p id="detail-desc" class="text-sm whitespace-pre-wrap leading-relaxed">...</p>
                </div>
                <div class="mt-6 pt-4 border-t border-skin-border">
                    <a id="detail-link" href="#" target="_blank" class="block w-full text-center bg-skin-primary hover:bg-skin-primary-hover text-white font-medium py-2 px-4 rounded transition">å‰å¾€ä¾†æºç¶²å€ <i class="fa-solid fa-arrow-up-right-from-square ml-1 text-xs"></i></a>
                    <button id="detail-delete-btn" onclick="deleteCurrentData()" class="hidden w-full mt-2 text-center text-red-500 hover:bg-red-50/10 font-medium py-2 px-4 rounded transition text-sm"><i class="fa-solid fa-trash-can mr-1"></i> åˆªé™¤æ­¤è³‡æ–™</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. æ–°å¢/ç·¨è¼¯è¦–çª— -->
    <div id="add-modal" class="fixed inset-0 z-50 hidden bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-skin-card rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto border border-skin-border text-skin-text">
            <div class="px-6 py-4 border-b border-skin-border flex justify-between items-center">
                <h3 id="modal-title" class="text-lg font-bold">æ–°å¢è³‡æ–™</h3>
                <button onclick="closeModal('add-modal')" class="text-skin-muted hover:text-skin-text"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <form id="data-form" onsubmit="event.preventDefault(); submitData();">
                    <!-- è¡¨å–®å…§å®¹ -->
                    <div>
                        <label class="block text-sm font-medium mb-1">ä¸»é¡åˆ¥</label>
                        <div class="flex space-x-2">
                            <select id="input-category" onchange="updateSubCategorySelect()" class="flex-1 border border-skin-border bg-skin-fill rounded px-3 py-2 text-sm focus:ring-1 focus:ring-skin-primary outline-none"></select>
                            <input type="text" id="new-category-input" placeholder="æ–°ä¸»é¡åˆ¥..." class="flex-1 border border-skin-border bg-skin-fill rounded px-3 py-2 text-sm focus:ring-1 focus:ring-skin-primary outline-none">
                            <button type="button" onclick="addNewCategory()" class="bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700 text-sm"><i class="fa-solid fa-plus"></i></button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">å­é¡åˆ¥</label>
                        <div class="flex space-x-2">
                            <select id="input-subcategory" class="flex-1 border border-skin-border bg-skin-fill rounded px-3 py-2 text-sm focus:ring-1 focus:ring-skin-primary outline-none"><option value="">ç„¡</option></select>
                            <input type="text" id="new-subcategory-input" placeholder="æ–°å­é¡åˆ¥..." class="flex-1 border border-skin-border bg-skin-fill rounded px-3 py-2 text-sm focus:ring-1 focus:ring-skin-primary outline-none">
                            <button type="button" onclick="addNewSubCategory()" class="bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700 text-sm"><i class="fa-solid fa-plus"></i></button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">æ¨™é¡Œ</label>
                        <input type="text" id="input-title" required class="w-full border border-skin-border bg-skin-fill rounded px-3 py-2 text-sm focus:ring-1 focus:ring-skin-primary outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">æ¨™ç±¤</label>
                        <input type="text" id="input-tags" class="w-full border border-skin-border bg-skin-fill rounded px-3 py-2 text-sm focus:ring-1 focus:ring-skin-primary outline-none">
                        <div id="available-tags" class="mt-2 flex flex-wrap gap-1 min-h-[1.5rem]"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">åœ–ç‰‡</label>
                        <div id="image-preview-container" class="hidden relative mb-2">
                            <img id="image-preview" src="" class="max-h-48 mx-auto rounded shadow-sm border border-skin-border">
                            <button type="button" onclick="clearImage()" class="absolute top-0 right-0 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs m-1 shadow-md hover:bg-red-600"><i class="fa-solid fa-times"></i></button>
                        </div>
                        <div id="upload-buttons" class="grid grid-cols-2 gap-4">
                            <input type="file" id="input-image" accept="image/*" class="hidden" onchange="previewImage(this)">
                            <button type="button" onclick="document.getElementById('input-image').click()" class="flex flex-col items-center justify-center p-4 border-2 border-dashed border-skin-primary/50 rounded-lg hover:bg-skin-fill text-skin-primary transition">
                                <i class="fa-solid fa-cloud-arrow-up text-xl mb-1"></i> <span class="text-sm">é»æ“Šä¸Šå‚³</span>
                            </button>
                            <button type="button" onclick="handlePasteBtnClick()" class="flex flex-col items-center justify-center p-4 border-2 border-dashed border-skin-muted/50 rounded-lg hover:bg-skin-fill text-skin-muted transition">
                                <i class="fa-regular fa-clipboard text-xl mb-1"></i> <span class="text-sm">è²¼ä¸Šåœ–ç‰‡</span>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">èªªæ˜</label>
                        <textarea id="input-desc" rows="4" class="w-full border border-skin-border bg-skin-fill rounded px-3 py-2 text-sm focus:ring-1 focus:ring-skin-primary outline-none"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">ä¾†æºç¶²å€</label>
                        <input type="url" id="input-url" class="w-full border border-skin-border bg-skin-fill rounded px-3 py-2 text-sm focus:ring-1 focus:ring-skin-primary outline-none">
                    </div>
                    <div class="pt-4">
                        <button type="submit" id="submit-btn" class="w-full bg-skin-primary hover:bg-skin-primary-hover text-white font-bold py-2 px-4 rounded transition">å„²å­˜è³‡æ–™</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 3. è¨­å®šè¦–çª— -->
    <div id="settings-modal" class="fixed inset-0 z-50 hidden bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-skin-card rounded-lg shadow-xl w-full max-w-lg text-skin-text border border-skin-border">
            <div class="px-6 py-4 border-b border-skin-border flex justify-between items-center">
                <h3 class="text-lg font-bold">è¨­å®š Firebase é€£ç·š</h3>
                <button onclick="closeModal('settings-modal')" class="text-skin-muted hover:text-skin-text"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-6">
                <textarea id="config-input" class="w-full h-40 border border-skin-border bg-skin-fill rounded p-2 text-xs font-mono outline-none" placeholder="è²¼ä¸Š firebaseConfig..."></textarea>
                <button onclick="saveConfig()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition my-4">å„²å­˜ä¸¦é‡æ–°æ•´ç†</button>
                <div class="border-t border-skin-border pt-4">
                    <button onclick="generateShareLink()" class="bg-skin-fill hover:brightness-95 text-skin-text text-xs px-3 py-2 rounded"><i class="fa-solid fa-link"></i> ç”¢ç”Ÿé€£çµ & QR</button>
                    <div id="share-result" class="hidden mt-4 text-center">
                        <div id="qrcode" class="flex justify-center mb-2 bg-white p-2 rounded w-fit mx-auto"></div>
                        <input type="text" id="share-url-input" class="w-full text-xs border border-skin-border p-1 rounded bg-skin-fill text-skin-text" readonly>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. èªªæ˜è¦–çª— (å·²ç§»é™¤ç™»å…¥å€å¡Š) -->
    <div id="help-modal" class="fixed inset-0 z-50 hidden bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-skin-card rounded-lg shadow-xl w-full max-w-md p-6 text-skin-text border border-skin-border">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">ä½¿ç”¨èªªæ˜</h3>
                <button onclick="closeModal('help-modal')" class="text-skin-muted hover:text-skin-text"><i class="fa-solid fa-times"></i></button>
            </div>
            <ul class="list-disc list-inside text-sm text-skin-muted space-y-2">
                <li>æœ¬ç¶²é å®Œå…¨å…è²»ï¼Œä½¿ç”¨ Firebase Firestore å„²å­˜ã€‚</li>
                <li>æ”¯æ´æ·±è‰²æ¨¡å¼ã€å¤šç¨®ç‰ˆé¢åˆ‡æ›ã€‚</li>
                <li>åœ–ç‰‡ä¸Šå‚³è‡ªå‹•å£“ç¸®ï¼Œç¯€çœæµé‡ã€‚</li>
                <li>é»æ“Šã€Œç®¡ç†è€…ç™»å…¥ã€é€²è¡Œè³‡æ–™ç¶­è­·ã€‚</li>
            </ul>
        </div>
    </div>

    <!-- 5. å…¨åœ–æª¢è¦– -->
    <div id="full-image-modal" class="fixed inset-0 z-[60] hidden bg-black/95 flex flex-col items-center justify-center p-4 animate-fade-in">
        <div class="absolute top-0 left-0 right-0 p-4 flex justify-between items-center bg-gradient-to-b from-black/50 to-transparent">
            <span class="text-white text-sm font-medium ml-2"><i class="fa-regular fa-image mr-2"></i>å…¨åœ–é è¦½</span>
            <div class="flex space-x-4">
                <a id="full-image-download" href="#" download="image.jpg" class="flex items-center text-white bg-white/20 hover:bg-white/30 px-4 py-2 rounded-full text-sm backdrop-blur-sm transition"><i class="fa-solid fa-download mr-2"></i> ä¸‹è¼‰</a>
                <button onclick="closeModal('full-image-modal')" class="flex items-center text-white bg-white/20 hover:bg-red-500/80 px-4 py-2 rounded-full text-sm backdrop-blur-sm transition"><i class="fa-solid fa-times mr-2"></i> é—œé–‰</button>
            </div>
        </div>
        <div class="w-full h-full flex items-center justify-center overflow-hidden">
            <img id="full-image-view" src="" class="max-w-full max-h-full object-contain rounded shadow-2xl">
        </div>
    </div>

    <!-- 6. ç®¡ç†è€…ç™»å…¥è¦–çª— (æ–°å¢) -->
    <div id="login-modal" class="fixed inset-0 z-50 hidden bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-skin-card rounded-lg shadow-xl w-full max-w-sm p-6 text-skin-text border border-skin-border relative">
            <button onclick="closeModal('login-modal')" class="absolute top-2 right-2 text-skin-muted hover:text-skin-text w-8 h-8 flex items-center justify-center rounded-full hover:bg-skin-fill"><i class="fa-solid fa-times"></i></button>
            
            <h3 class="text-lg font-bold mb-4 text-center">ç®¡ç†è€…ç™»å…¥</h3>
            <div class="flex flex-col gap-3">
                <input type="password" id="admin-password" placeholder="è¼¸å…¥å¯†ç¢¼" class="w-full border border-skin-border bg-skin-fill rounded px-3 py-2 text-sm focus:ring-1 focus:ring-skin-primary outline-none" onkeydown="if(event.key === 'Enter') checkAdmin()">
                <button onclick="checkAdmin()" class="w-full bg-skin-text text-skin-card px-4 py-2 rounded text-sm hover:opacity-90 transition">ç™»å…¥</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        //  UI äº’å‹•èˆ‡é‚è¼¯
        // ==========================================

        let currentDetailId = null;

        function checkAdmin() {
            const pwd = document.getElementById('admin-password').value;
            if (pwd === 'admin') {
                isAdmin = true;
                const btn = document.getElementById('admin-btn');
                btn.classList.add('bg-green-600', 'text-white');
                btn.innerHTML = '<i class="fa-solid fa-check mr-1"></i> å·²ç™»å…¥';
                document.getElementById('add-data-btn').classList.remove('hidden');
                document.getElementById('detail-delete-btn').classList.remove('hidden');
                closeModal('login-modal');
                alert("ç®¡ç†å“¡ç™»å…¥æˆåŠŸï¼");
                renderGrid();
            } else {
                alert("å¯†ç¢¼éŒ¯èª¤");
                document.getElementById('admin-password').value = '';
            }
        }

        function toggleAdminPanel() {
            if(!isAdmin) {
                openModal('login-modal');
                setTimeout(() => document.getElementById('admin-password').focus(), 100);
            }
        }

        // --- Theme Logic ---
        function handleThemeChange() {
            const newTheme = document.getElementById('theme-select').value;
            setTheme(newTheme);
        }

        function setTheme(themeName) {
            currentTheme = themeName;
            document.documentElement.setAttribute('data-theme', themeName);
            // è™•ç†æ·±è‰²æ¨¡å¼ classï¼Œè®“ Tailwind çš„ dark: modifier ç”Ÿæ•ˆ
            if (themeName === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            localStorage.setItem('app_theme', themeName);
            document.getElementById('theme-select').value = themeName;
        }

        function loadTheme() {
            const saved = localStorage.getItem('app_theme') || 'modern';
            setTheme(saved);
        }

        // --- Firestore Data ---
        function loadData() {
            if (!db) return;
            db.collection('infos').orderBy('createdAt', 'desc').onSnapshot((snapshot) => {
                allData = [];
                allTags.clear();
                snapshot.forEach(doc => {
                    const data = doc.data();
                    allData.push({ id: doc.id, ...data });
                    if (data.tags) data.tags.forEach(t => allTags.add(t));
                });
                extractCategories();
                handleSearch(); 
            });
        }

        // (çœç•¥ loadCategories èˆ‡ extractCategoriesï¼Œèˆ‡ä¹‹å‰ç›¸åŒ)
        function loadCategories() {
            if(!db) return;
            db.collection('categories').onSnapshot(snap => {
                snap.forEach(doc => {
                    const data = doc.data();
                    if (data.name) {
                        if (!categoryStructure[data.name]) categoryStructure[data.name] = new Set();
                        if (data.subs && Array.isArray(data.subs)) data.subs.forEach(sub => categoryStructure[data.name].add(sub));
                    }
                });
                renderCategoryFilter();
            });
        }

        function extractCategories() {
            allData.forEach(item => {
                if (item.category) {
                    if (!categoryStructure[item.category]) categoryStructure[item.category] = new Set();
                    if (item.subCategory) categoryStructure[item.category].add(item.subCategory);
                }
            });
            renderCategoryFilter();
        }

        function renderCategoryFilter() {
            const container = document.getElementById('category-filter-container');
            container.innerHTML = `<button class="bg-skin-primary text-white px-3 py-1 rounded-full text-sm whitespace-nowrap active-cat" onclick="filterByCategory('å…¨éƒ¨', this)">å…¨éƒ¨</button>`;
            Object.keys(categoryStructure).sort().forEach(cat => {
                const btn = document.createElement('button');
                btn.className = `bg-skin-card hover:bg-skin-fill text-skin-text border border-skin-border px-3 py-1 rounded-full text-sm whitespace-nowrap transition category-btn`;
                btn.textContent = cat;
                btn.onclick = () => filterByCategory(cat, btn);
                container.appendChild(btn);
            });
            updateInputCategories();
        }

        function renderSubCategoryFilter() {
            const wrapper = document.getElementById('subcategory-wrapper');
            const container = document.getElementById('subcategory-filter-container');
            container.innerHTML = '';
            if (currentCategory === 'å…¨éƒ¨' || !categoryStructure[currentCategory] || categoryStructure[currentCategory].size === 0) {
                wrapper.classList.add('hidden');
                currentSubCategory = 'å…¨éƒ¨';
                return;
            }
            wrapper.classList.remove('hidden');
            const allBtn = document.createElement('button');
            allBtn.className = `bg-skin-primary text-white px-3 py-1 rounded-full text-xs whitespace-nowrap active-subcat`;
            allBtn.textContent = 'å…¨éƒ¨';
            allBtn.onclick = () => filterBySubCategory('å…¨éƒ¨', allBtn);
            container.appendChild(allBtn);
            Array.from(categoryStructure[currentCategory]).sort().forEach(sub => {
                const btn = document.createElement('button');
                btn.className = `bg-skin-card hover:bg-skin-fill text-skin-text border border-skin-border px-3 py-1 rounded-full text-xs whitespace-nowrap transition subcategory-btn`;
                btn.textContent = sub;
                btn.onclick = () => filterBySubCategory(sub, btn);
                container.appendChild(btn);
            });
        }

        function updateInputCategories() {
            const select = document.getElementById('input-category');
            const currentVal = select.value;
            select.innerHTML = '';
            const cats = Object.keys(categoryStructure).sort();
            if (cats.length === 0) select.appendChild(new Option("ä¸€èˆ¬", "ä¸€èˆ¬"));
            else cats.forEach(cat => select.appendChild(new Option(cat, cat)));
            if(currentVal && cats.includes(currentVal)) select.value = currentVal;
            updateSubCategorySelect();
        }

        function updateSubCategorySelect() {
            const mainCat = document.getElementById('input-category').value;
            const subSelect = document.getElementById('input-subcategory');
            subSelect.innerHTML = '<option value="">ç„¡</option>';
            if (mainCat && categoryStructure[mainCat]) {
                Array.from(categoryStructure[mainCat]).sort().forEach(sub => subSelect.appendChild(new Option(sub, sub)));
            }
        }

        function filterByCategory(cat, btn) {
            currentCategory = cat;
            document.querySelectorAll('.category-btn, .active-cat').forEach(b => {
                b.classList.remove('bg-skin-primary', 'text-white', 'active-cat');
                b.classList.add('bg-skin-card', 'text-skin-text');
            });
            if(btn) {
                btn.classList.remove('bg-skin-card', 'text-skin-text');
                btn.classList.add('bg-skin-primary', 'text-white', 'active-cat');
            }
            currentSubCategory = 'å…¨éƒ¨';
            renderSubCategoryFilter();
            handleSearch();
        }

        function filterBySubCategory(sub, btn) {
            currentSubCategory = sub;
            document.querySelectorAll('.subcategory-btn, .active-subcat').forEach(b => {
                b.classList.remove('bg-skin-primary', 'text-white', 'active-subcat');
                b.classList.add('bg-skin-card', 'text-skin-text');
            });
            if(btn) {
                btn.classList.remove('bg-skin-card', 'text-skin-text');
                btn.classList.add('bg-skin-primary', 'text-white', 'active-subcat');
            }
            handleSearch();
        }

        function handleViewChange() {
            currentViewMode = document.getElementById('view-select').value;
            renderGrid();
        }

        function handleSearch() {
            const query = document.getElementById('search-input').value.toLowerCase();
            filteredData = allData.filter(item => {
                if (currentCategory !== 'å…¨éƒ¨' && item.category !== currentCategory) return false;
                if (currentSubCategory !== 'å…¨éƒ¨' && (item.subCategory || 'ç„¡') !== currentSubCategory) return false;
                const inTitle = item.title.toLowerCase().includes(query);
                const inTags = item.tags ? item.tags.some(t => t.toLowerCase().includes(query)) : false;
                return inTitle || inTags;
            });
            handleSort();
        }

        function handleSort() {
            const sortType = document.getElementById('sort-select').value;
            filteredData.sort((a, b) => {
                const timeA = a.createdAt ? a.createdAt.seconds : 0;
                const timeB = b.createdAt ? b.createdAt.seconds : 0;
                return sortType === 'newest' ? timeB - timeA : timeA - timeB;
            });
            renderGrid();
        }

        function renderGrid() {
            const grid = document.getElementById('data-grid');
            grid.innerHTML = '';
            
            const viewConfig = {
                small: {
                    gridClass: "grid-cols-2 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3",
                    imgHeight: "h-28", titleSize: "text-sm", descSize: "text-xs line-clamp-2", tagSize: "text-[10px]", padding: "p-2", isList: false
                },
                medium: {
                    gridClass: "grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6",
                    imgHeight: "h-48", titleSize: "text-lg", descSize: "text-sm line-clamp-3", tagSize: "text-[10px]", padding: "p-4", isList: false
                },
                large: {
                    gridClass: "grid-cols-1 md:grid-cols-2 gap-8",
                    imgHeight: "h-72", titleSize: "text-2xl", descSize: "text-base line-clamp-4", tagSize: "text-xs", padding: "p-6", isList: false
                },
                list: {
                    gridClass: "grid-cols-1 gap-3", // å–®æ¬„
                    imgHeight: "h-24 w-32 shrink-0", // å›ºå®šå¯¬é«˜å°åœ–
                    titleSize: "text-lg", descSize: "text-sm line-clamp-2", tagSize: "text-xs", padding: "p-4", isList: true
                }
            };

            const config = viewConfig[currentViewMode];
            grid.className = `max-w-7xl mx-auto grid transition-all duration-300 ${config.gridClass}`;

            if (filteredData.length === 0) {
                grid.innerHTML = `<div class="col-span-full text-center text-skin-muted py-10">æ²’æœ‰ç¬¦åˆçš„è³‡æ–™</div>`;
                return;
            }

            filteredData.forEach(item => {
                const card = document.createElement('div');
                card.className = "bg-skin-card rounded-lg shadow-sm hover:shadow-md transition cursor-pointer overflow-hidden border border-skin-border flex relative group hover:border-skin-primary/50";
                
                // æ ¹æ“šæ¨¡å¼åˆ‡æ› Flex æ–¹å‘
                if (!config.isList) card.classList.add('flex-col', 'h-full');
                else card.classList.add('flex-row', 'items-center');

                card.onclick = () => openDetail(item);

                const tagsHtml = item.tags ? item.tags.map(t => `<span class="${getTagClass(t)} ${config.tagSize} px-2 py-0.5 rounded-full mr-1">#${t}</span>`).join('') : '';
                const editBtnHtml = isAdmin ? `<button onclick="event.stopPropagation(); openEditModal('${item.id}')" class="absolute top-2 right-2 bg-skin-card/90 hover:bg-skin-fill text-skin-muted hover:text-skin-primary w-8 h-8 rounded-full flex items-center justify-center shadow-md z-20 transition transform hover:scale-110 border border-skin-border"><i class="fa-solid fa-pen text-xs"></i></button>` : '';

                let catDisplay = item.category;
                if (item.subCategory) catDisplay += ` > ${item.subCategory}`;
                const catBadgeSize = currentViewMode === 'small' ? 'text-[10px] px-1.5 py-0.5' : 'text-xs px-2 py-1';

                // åœ–ç‰‡å€å¡Š
                const imgContainer = document.createElement('div');
                imgContainer.className = `${config.imgHeight} bg-skin-fill relative overflow-hidden group-img`;
                
                // åˆ—è¡¨æ¨¡å¼æ™‚ï¼Œåœ–ç‰‡ä¸éœ€è¦çµ•å°å®šä½çš„æ–‡å­—æ¨™ç±¤(å› ç‚ºç©ºé–“å¤ªå°)ï¼Œæˆ–è€…å¯ä»¥ç°¡åŒ–
                const badgeHtml = config.isList 
                    ? '' 
                    : `<span class="absolute top-2 left-2 bg-black/60 backdrop-blur-sm text-white ${catBadgeSize} rounded z-10 truncate max-w-[80%]">${catDisplay}</span>`;

                imgContainer.innerHTML = `
                    <img src="${item.image || 'https://via.placeholder.com/400x200'}" class="w-full h-full object-cover object-center transition transform group-hover:scale-105" loading="lazy">
                    ${badgeHtml}
                    ${editBtnHtml}
                `;

                // å…§å®¹å€å¡Š
                const contentContainer = document.createElement('div');
                contentContainer.className = `${config.padding} flex flex-col flex-grow min-w-0`; // min-w-0 ç¢ºä¿æ–‡å­—æˆªæ–·æ­£å¸¸
                
                // åˆ—è¡¨æ¨¡å¼çš„é¡å¤–æ¨™é¡Œåˆ—è™•ç†
                if (config.isList) {
                    contentContainer.innerHTML = `
                        <div class="flex justify-between items-start">
                            <h3 class="font-bold text-skin-text mb-1 ${config.titleSize} truncate">${item.title}</h3>
                            <span class="text-xs text-skin-muted ml-2 shrink-0 bg-skin-fill px-2 py-1 rounded">${catDisplay}</span>
                        </div>
                        <div class="mb-1 flex flex-wrap gap-y-1">${tagsHtml}</div>
                        <p class="text-skin-muted ${config.descSize}">${item.desc || 'ç„¡èªªæ˜'}</p>
                    `;
                } else {
                    contentContainer.innerHTML = `
                        <div class="mb-2 flex flex-wrap gap-y-1">${tagsHtml}</div>
                        <h3 class="font-bold text-skin-text mb-1 ${config.titleSize} leading-tight">${item.title}</h3>
                        <p class="text-skin-muted ${config.descSize} flex-grow">${item.desc || 'ç„¡èªªæ˜'}</p>
                    `;
                }

                card.appendChild(imgContainer);
                card.appendChild(contentContainer);
                grid.appendChild(card);
            });
        }

        // --- CRUD & Utils (ä¿æŒèˆ‡ä¹‹å‰é‚è¼¯ç›¸åŒï¼Œåƒ…æ›´æ–° UI Class åƒç…§) ---
        // (çœç•¥éƒ¨åˆ†é‡è¤‡çš„ CRUD é‚è¼¯ï¼Œèˆ‡ä¸Šå€‹ç‰ˆæœ¬ä¸€è‡´ï¼Œç›´æ¥ä½¿ç”¨å³å¯)
        
        async function submitData() {
            if (!db || !isAdmin) return alert("æ¬Šé™ä¸è¶³");
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = "è™•ç†ä¸­...";
            try {
                // ... (è³‡æ–™æ”¶é›†é‚è¼¯)
                const title = document.getElementById('input-title').value;
                const category = document.getElementById('input-category').value;
                const subCategory = document.getElementById('input-subcategory').value || null;
                const tags = document.getElementById('input-tags').value.split(/[,ï¼Œ]/).map(t => t.trim()).filter(t => t);
                const desc = document.getElementById('input-desc').value;
                const url = document.getElementById('input-url').value;
                
                const imgPreview = document.getElementById('image-preview');
                let imageBase64 = null;
                if (imgPreview.src && !imgPreview.src.startsWith('http')) imageBase64 = imgPreview.src;
                else if (document.getElementById('input-image').files[0]) imageBase64 = await resizeImage(document.getElementById('input-image').files[0]);
                else if (isEditing && imgPreview.src) imageBase64 = imgPreview.src;
                if (!imageBase64) imageBase64 = "https://via.placeholder.com/400x300?text=No+Image";

                const dataPayload = {
                    title, category, subCategory, tags, desc, url, image: imageBase64,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                if (isEditing && editingId) {
                    await db.collection('infos').doc(editingId).update(dataPayload);
                    alert("æ›´æ–°æˆåŠŸï¼");
                } else {
                    dataPayload.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('infos').add(dataPayload);
                    alert("æ–°å¢æˆåŠŸï¼");
                }
                closeModal('add-modal');
                document.getElementById('data-form').reset();
                clearImage();
            } catch (error) {
                console.error(error);
                alert("æ“ä½œå¤±æ•—: " + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = isEditing ? "å„²å­˜ä¿®æ”¹" : "æ–°å¢è³‡æ–™";
            }
        }
        
        async function addNewCategory() {
            if(!isAdmin) return;
            const newCat = document.getElementById('new-category-input').value.trim();
            if(newCat && !categoryStructure[newCat]) {
                 try {
                    await db.collection('categories').add({ name: newCat, subs: [] });
                    alert("ä¸»é¡åˆ¥å·²æ–°å¢");
                    if(!categoryStructure[newCat]) categoryStructure[newCat] = new Set();
                    updateInputCategories();
                    document.getElementById('input-category').value = newCat;
                    updateSubCategorySelect();
                } catch(e) { console.error(e); }
                document.getElementById('new-category-input').value = "";
            }
        }

        async function addNewSubCategory() {
            if(!isAdmin) return;
            const mainCat = document.getElementById('input-category').value;
            const newSub = document.getElementById('new-subcategory-input').value.trim();
            if(mainCat && newSub) {
                const q = await db.collection('categories').where('name', '==', mainCat).get();
                if (!q.empty) {
                    q.forEach(async doc => await doc.ref.update({ subs: firebase.firestore.FieldValue.arrayUnion(newSub) }));
                } else {
                    await db.collection('categories').add({ name: mainCat, subs: [newSub] });
                }
                if(!categoryStructure[mainCat]) categoryStructure[mainCat] = new Set();
                categoryStructure[mainCat].add(newSub);
                alert("å­é¡åˆ¥å·²æ–°å¢");
                updateSubCategorySelect();
                document.getElementById('input-subcategory').value = newSub;
                document.getElementById('new-subcategory-input').value = "";
            }
        }

        function deleteCurrentData() {
            if (!db || !currentDetailId || !isAdmin) return;
            if (confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) {
                db.collection('infos').doc(currentDetailId).delete()
                    .then(() => { closeModal('detail-modal'); alert("åˆªé™¤æˆåŠŸ"); })
                    .catch(() => alert("åˆªé™¤å¤±æ•—"));
            }
        }

        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        function openAddModal() {
            if(!isAdmin) return alert("æ¬Šé™ä¸è¶³");
            isEditing = false; editingId = null;
            document.getElementById('modal-title').textContent = "æ–°å¢è³‡æ–™";
            document.getElementById('submit-btn').textContent = "æ–°å¢è³‡æ–™";
            document.getElementById('data-form').reset();
            clearImage();
            updateInputCategories();
            renderAvailableTags();
            openModal('add-modal');
        }

        function openEditModal(id) {
            if(!isAdmin) return alert("æ¬Šé™ä¸è¶³");
            const item = allData.find(d => d.id === id);
            if(!item) return;
            isEditing = true; editingId = id;
            document.getElementById('modal-title').textContent = "ç·¨è¼¯è³‡æ–™";
            document.getElementById('submit-btn').textContent = "å„²å­˜ä¿®æ”¹";
            document.getElementById('input-title').value = item.title;
            document.getElementById('input-tags').value = item.tags ? item.tags.join(', ') : '';
            document.getElementById('input-desc').value = item.desc || '';
            document.getElementById('input-url').value = item.url || '';
            updateInputCategories();
            document.getElementById('input-category').value = item.category;
            updateSubCategorySelect();
            if(item.subCategory) {
                const subSelect = document.getElementById('input-subcategory');
                let exists = false;
                for(let i=0; i<subSelect.options.length; i++) if(subSelect.options[i].value === item.subCategory) exists = true;
                if(!exists) subSelect.appendChild(new Option(item.subCategory, item.subCategory));
                subSelect.value = item.subCategory;
            }
            if(item.image) {
                document.getElementById('image-preview').src = item.image;
                document.getElementById('image-preview-container').classList.remove('hidden');
                document.getElementById('upload-buttons').classList.add('hidden');
            } else clearImage();
            renderAvailableTags();
            openModal('add-modal');
        }

        function openDetail(item) {
            currentDetailId = item.id;
            document.getElementById('detail-img').src = item.image || '';
            document.getElementById('detail-download-btn').href = item.image || '#';
            let catDisplay = item.category || 'æœªåˆ†é¡';
            if (item.subCategory) catDisplay += ` > ${item.subCategory}`;
            document.getElementById('detail-category').textContent = catDisplay;
            document.getElementById('detail-title').textContent = item.title;
            document.getElementById('detail-desc').textContent = item.desc || '';
            document.getElementById('detail-link').href = item.url || '#';
            const tagsContainer = document.getElementById('detail-tags');
            tagsContainer.innerHTML = item.tags ? item.tags.map(t => `<span class="${getTagClass(t)} px-2 py-1 rounded mr-1">#${t}</span>`).join('') : '';
            const delBtn = document.getElementById('detail-delete-btn');
            if(isAdmin) delBtn.classList.remove('hidden'); else delBtn.classList.add('hidden');
            openModal('detail-modal');
        }

        function viewFullImage() {
            const src = document.getElementById('detail-img').src;
            if(!src) return;
            document.getElementById('full-image-view').src = src;
            document.getElementById('full-image-download').href = src;
            openModal('full-image-modal');
        }

        function renderAvailableTags() {
            const container = document.getElementById('available-tags');
            container.innerHTML = '';
            Array.from(allTags).forEach(tag => {
                const span = document.createElement('span');
                span.className = "bg-skin-fill hover:brightness-95 text-skin-muted text-xs px-2 py-1 rounded cursor-pointer border border-skin-border transition";
                span.textContent = tag;
                span.onclick = () => {
                    const input = document.getElementById('input-tags');
                    const val = input.value.trim();
                    if(val && !val.includes(tag)) input.value = val + ', ' + tag;
                    else if(!val) input.value = tag;
                };
                container.appendChild(span);
            });
        }
        
        // --- åœ–ç‰‡ä¸Šå‚³ç›¸é—œ ---
        document.addEventListener('paste', (e) => {
            if (!document.getElementById('add-modal').classList.contains('hidden') && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') handlePaste(e);
        });
        async function handlePasteBtnClick() {
            try {
                const items = await navigator.clipboard.read();
                for (const item of items) {
                    const type = item.types.find(t => t.startsWith('image/'));
                    if (type) {
                        const blob = await item.getType(type);
                        const base64 = await resizeImage(blob);
                        showPreview(base64);
                        return;
                    }
                }
                alert("å‰ªè²¼ç°¿ä¸­æ²’æœ‰åœ–ç‰‡");
            } catch (err) { alert("è«‹æŒ‰ Ctrl+V è²¼ä¸Š"); }
        }
        async function handlePaste(e) {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (const item of items) {
                if (item.kind === 'file' && item.type.startsWith('image/')) {
                    const base64 = await resizeImage(item.getAsFile());
                    showPreview(base64);
                }
            }
        }
        async function previewImage(input) {
            if (input.files && input.files[0]) {
                const base64 = await resizeImage(input.files[0]);
                showPreview(base64);
            }
        }
        function showPreview(src) {
            const img = document.getElementById('image-preview');
            img.src = src;
            document.getElementById('image-preview-container').classList.remove('hidden');
            document.getElementById('upload-buttons').classList.add('hidden');
        }
        function clearImage() {
            document.getElementById('input-image').value = '';
            document.getElementById('image-preview').src = '';
            document.getElementById('image-preview-container').classList.add('hidden');
            document.getElementById('upload-buttons').classList.remove('hidden');
        }
        function resizeImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800;
                        let w = img.width, h = img.height;
                        if (w > MAX_WIDTH) { h *= MAX_WIDTH / w; w = MAX_WIDTH; }
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                };
                reader.onerror = reject;
            });
        }
        // --- è¨­å®šèˆ‡åˆ†äº« ---
        function saveConfig() {
            const text = document.getElementById('config-input').value;
            const keys = ['apiKey', 'authDomain', 'projectId', 'storageBucket', 'messagingSenderId', 'appId'];
            const config = {};
            keys.forEach(key => {
                const match = text.match(new RegExp(`${key}\\s*:\\s*["']([^"']+)["']`));
                if (match) config[key] = match[1];
            });
            if (config.apiKey) {
                localStorage.setItem('firebase_config', JSON.stringify(config));
                location.reload();
            } else alert("Config è§£æå¤±æ•—");
        }
        function generateShareLink() {
            const config = localStorage.getItem('firebase_config');
            if (!config) return alert("ç„¡è¨­å®šå¯åˆ†äº«");
            const url = `${location.href.split('?')[0]}?config=${btoa(config)}`;
            document.getElementById('share-result').classList.remove('hidden');
            document.getElementById('share-url-input').value = url;
            document.getElementById('qrcode').innerHTML = '';
            new QRCode(document.getElementById('qrcode'), { text: url, width: 128, height: 128 });
        }
        function copyToClipboard(id) {
            navigator.clipboard.writeText(document.getElementById(id).innerText).then(() => alert("å·²è¤‡è£½")).catch(console.error);
        }
        window.onclick = function(e) { if (e.target.classList.contains('fixed')) e.target.classList.add('hidden'); }
    </script>
</body>
</html>